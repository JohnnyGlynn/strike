syntax = "proto3";

import "google/protobuf/timestamp.proto";
import "common.proto";

package message;

option go_package="./message";

service Strike {
  //TODO: Just login?
  rpc Signup(InitUser) returns (ServerResponse) {}

  rpc Login(LoginVerify) returns (ServerResponse) {}

  rpc SaltMine(common.UserInfo) returns (Salt) {}

  rpc UserRequest(common.UserInfo) returns (common.UserInfo) {}

  rpc OnlineUsers(common.UserInfo) returns (Users) {}

  rpc StatusStream(common.UserInfo) returns (stream StatusUpdate) {}

  rpc SendPayload(StreamPayload) returns (ServerResponse) {}

  rpc PayloadStream(common.UserInfo) returns (stream StreamPayload) {}

  rpc PollServer(common.UserInfo) returns (ServerInfo) {}

  rpc DeliveryReceipt(Receipt) returns (ServerResponse) {}
}

//TODO: Lots of cleaning
message ServerInfo {
  string server_id = 1;
  string server_name = 2;
  repeated common.UserInfo users = 3;
}

message Users {
  repeated common.UserInfo users = 1;
}

//TODO: Getting very verbose here, prune
message Salt {
    bytes salt = 1;
}

message FriendRequest {
  string target = 2;
  common.UserInfo user_info = 4;
}

message FriendResponse {
  string target = 2;
  common.UserInfo user_info = 4;
  bool state = 5;
}

message InitUser {
  string username = 1;
  string user_id = 2;
  string password_hash = 3;
  Salt salt = 4;
  //byte array - https://protobuf.dev/programming-guides/proto3/#scalar
  bytes encryption_public_key = 5; // client Curve25519 public key
  bytes signing_public_key = 6; // client ED25519 signing key
}

message LoginVerify {
  string username = 1;
  string password_hash = 2;
}

message ServerResponse {
  bool success = 1;
  string message = 2;
  //TODO: Have server sign this?
  string message_id = 3;
}

message StatusUpdate {
    string message = 1;  //"online/offline"
    google.protobuf.Timestamp updated_at = 2;
}

// TODO: this is getting messy
message StreamPayload {
  string target = 1;
  string sender = 2;
  oneof payload {
    common.EncryptedEnvelope encenv = 6;
    KeyExchangeRequest key_exch_request = 7;
    KeyExchangeResponse key_exch_response = 8;
    KeyExchangeConfirmation key_exch_confirm = 9;
    FriendRequest friend_request = 10;
    FriendResponse friend_response = 11;
  }
  string info = 12;
}


// -----------------------------------Key Exchange---------------------------------------------
// TODO: these could proably be a single type
message KeyExchangeRequest {
  string target = 1;
  string sender_user_id = 2;
  bytes curve_public_key = 3;
  bytes nonce = 4;
  repeated bytes signatures = 5;
}

message KeyExchangeResponse {
  string responder_user_id = 1;
  bytes curve_public_key = 2;
  bytes nonce = 3;
  repeated bytes signatures = 4;
}

message KeyExchangeConfirmation {
  bool status = 1;
  string confirmer_user_id = 2;
}

message Receipt {
  string message_id = 1;
  string to = 2;
  bytes sig = 3;
  google.protobuf.Timestamp timestamp = 4;
}
